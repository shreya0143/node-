<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <%= recipe.title %> - Gourmet Recipes
    </title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <%- include('navbar.ejs') %>

        <div class="container">
            <div class="recipe-detail">
                <div class="recipe-header">
                    <h1>
                        <%= recipe.title %>
                            <% if (typeof user !=='undefined' && user) { %>
                                <form action="/recipes/<%= recipe._id %>/favorite" method="POST"
                                    style="display:inline-block; vertical-align:middle; margin-left: 10px;">
                                    <button type="submit"
                                        class="btn-heart <%= user.favorites && user.favorites.some(f => f.toString() === recipe._id.toString()) ? 'favorited' : '' %>"
                                        style="width: 40px; height: 40px; font-size: 1.5rem; box-shadow: none; background: transparent;">
                                        <%= user.favorites && user.favorites.some(f=> f.toString() ===
                                            recipe._id.toString()) ? 'â¤ï¸' : 'ðŸ¤' %>
                                    </button>
                                </form>
                                <% } %>
                    </h1>
                    <p>Shared by <strong>
                            <%= recipe.createdBy.username %>
                        </strong> on <%= recipe.createdAt.toDateString() %>
                    </p>
                    <img src="<%= recipe.image %>" alt="<%= recipe.title %>"
                        onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">

                    <% if (typeof user !=='undefined' && user && (user.role==='admin' || (recipe.createdBy &&
                        recipe.createdBy._id.toString()===user.id))) { %>
                        <div class="owner-actions" style="margin-top: 1.5rem;">
                            <a href="/recipes/edit/<%= recipe._id %>" class="btn btn-outline"
                                style="margin-right: 1rem;">Edit Recipe</a>
                            <form action="/recipes/delete/<%= recipe._id %>" method="POST" style="display:inline-block;"
                                onsubmit="return confirm('Are you sure you want to delete this recipe?');">
                                <button type="submit" class="btn btn-danger">Delete Recipe</button>
                            </form>
                        </div>
                        <% } %>
                </div>

                <div class="recipe-info">
                    <div>
                        <strong>Cooking Time:</strong><br>
                        <%= recipe.cookingTime %>
                    </div>
                    <div>
                        <strong>Category:</strong><br>
                        <%= recipe.category || 'N/A' %>
                    </div>
                    <div>
                        <strong>Difficulty:</strong><br>
                        <%= recipe.difficulty %>
                    </div>
                </div>

                <div class="recipe-body">
                    <h3>Ingredients:</h3>
                    <ul>
                        <% recipe.ingredients.forEach(ingredient=> { %>
                            <li>
                                <%= ingredient %>
                            </li>
                            <% }) %>
                    </ul>

                    <h3>Instructions:</h3>
                    <p style="white-space: pre-line;">
                        <%= recipe.instructions %>
                    </p>
                </div>

                <div class="comments-section">
                    <h3>Comments (<%= comments.length %>)</h3>

                    <% if (comments.length> 0) { %>
                        <% comments.forEach(comment=> { %>
                            <div class="comment">
                                <p><strong>
                                        <%= comment.userId.username %>:
                                    </strong>
                                    <%= comment.content %>
                                </p>
                                <small>
                                    <%= comment.createdAt.toLocaleDateString() %>
                                </small>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p>No comments yet.</p>
                                    <% } %>

                                        <% if (user) { %>
                                            <form action="/recipes/<%= recipe._id %>/comment" method="POST"
                                                style="margin-top: 20px;">
                                                <div class="form-group">
                                                    <textarea name="content" placeholder="Write a comment..."
                                                        required></textarea>
                                                </div>
                                                <button type="submit">Post Comment</button>
                                            </form>
                                            <% } else { %>
                                                <p><a href="/login">Login</a> to create a comment.</p>
                                                <% } %>
                </div>
            </div>
        </div>
</body>

</html>